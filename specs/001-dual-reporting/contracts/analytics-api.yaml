openapi: 3.0.3
info:
  title: Analytics & Dashboard API Service
  description: |
    Executive dashboards for CEO and CFO. Real-time metrics, KPIs, and reporting.
    Implements Constitution Principle I (CEO/CFO God-mode visibility).
  version: 1.0.0

servers:
  - url: /api/v1/analytics
    description: Analytics Service

tags:
  - name: CEO Dashboard
    description: Strategic metrics and OKR tracking (CEO only)
  - name: CFO Dashboard
    description: Financial metrics and P&L (CFO only)
  - name: GM Dashboard
    description: Operational overview for General Manager
  - name: Director Dashboard
    description: SDD team performance for Directors
  - name: Exports
    description: Report and presentation exports

paths:
  # ========================================
  # CEO DASHBOARD
  # ========================================

  /dashboards/ceo:
    get:
      tags: [CEO Dashboard]
      summary: Get CEO dashboard summary
      description: |
        **Access:** CEO only.
        Returns aggregated strategic metrics including OKRs, attrition risk, and client churn.
      operationId: getCeoDashboard
      security:
        - sanctum: []
      responses:
        '200':
          description: CEO dashboard data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CeoDashboard'
        '403':
          description: Only CEO can access this dashboard

  /dashboards/ceo/okrs:
    get:
      tags: [CEO Dashboard]
      summary: Get OKR tracking details
      operationId: getCeoOkrs
      security:
        - sanctum: []
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: [current_quarter, previous_quarter, current_year]
            default: current_quarter
      responses:
        '200':
          description: OKR list with progress
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkrList'

  /dashboards/ceo/attrition-risk:
    get:
      tags: [CEO Dashboard]
      summary: Get employee attrition risk predictions
      description: |
        Returns employees ranked by predicted attrition probability.
        Data sourced from AI/ML service.
      operationId: getAttritionRisk
      security:
        - sanctum: []
      parameters:
        - name: threshold
          in: query
          description: Minimum risk score (0-1) to include
          schema:
            type: number
            default: 0.5
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Attrition risk predictions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AttritionRiskList'

  /dashboards/ceo/client-churn:
    get:
      tags: [CEO Dashboard]
      summary: Get client churn risk predictions
      operationId: getClientChurnRisk
      security:
        - sanctum: []
      parameters:
        - name: threshold
          in: query
          schema:
            type: number
            default: 0.5
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
      responses:
        '200':
          description: Client churn predictions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientChurnList'

  /dashboards/ceo/board-presentation:
    post:
      tags: [CEO Dashboard]
      summary: Generate board presentation
      description: |
        Generates a PowerPoint/PDF presentation summarizing key metrics.
        Returns a download URL when ready.
      operationId: generateBoardPresentation
      security:
        - sanctum: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                format:
                  type: string
                  enum: [pdf, pptx]
                  default: pdf
                include_sections:
                  type: array
                  items:
                    type: string
                    enum: [okrs, financials, projects, attrition, churn]
                  default: [okrs, financials, projects]
      responses:
        '202':
          description: Generation started
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: string
                  estimated_seconds:
                    type: integer
        '403':
          description: Only CEO can generate board presentations

  /dashboards/ceo/board-presentation/{jobId}:
    get:
      tags: [CEO Dashboard]
      summary: Check presentation generation status
      operationId: getBoardPresentationStatus
      security:
        - sanctum: []
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job status
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [pending, processing, completed, failed]
                  download_url:
                    type: string
                    description: Available when status is 'completed'
                  expires_at:
                    type: string
                    format: date-time

  # ========================================
  # CFO DASHBOARD
  # ========================================

  /dashboards/cfo:
    get:
      tags: [CFO Dashboard]
      summary: Get CFO dashboard summary
      description: |
        **Access:** CFO only.
        Returns financial overview including P&L, cash runway, and budget variances.
      operationId: getCfoDashboard
      security:
        - sanctum: []
      responses:
        '200':
          description: CFO dashboard data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CfoDashboard'
        '403':
          description: Only CFO can access this dashboard

  /dashboards/cfo/profit-loss:
    get:
      tags: [CFO Dashboard]
      summary: Get P&L statement
      operationId: getProfitLoss
      security:
        - sanctum: []
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: [mtd, qtd, ytd, custom]
            default: mtd
        - name: start_date
          in: query
          description: Required if period is 'custom'
          schema:
            type: string
            format: date
        - name: end_date
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: P&L data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfitLossStatement'

  /dashboards/cfo/cash-runway:
    get:
      tags: [CFO Dashboard]
      summary: Get cash runway projection
      operationId: getCashRunway
      security:
        - sanctum: []
      responses:
        '200':
          description: Cash runway data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CashRunway'

  /dashboards/cfo/budget-variance:
    get:
      tags: [CFO Dashboard]
      summary: Get budget vs actuals by project
      operationId: getBudgetVariance
      security:
        - sanctum: []
      parameters:
        - name: project_id
          in: query
          schema:
            type: integer
        - name: fiscal_year
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Budget variance data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BudgetVarianceList'

  /dashboards/cfo/ar-aging:
    get:
      tags: [CFO Dashboard]
      summary: Get accounts receivable aging
      operationId: getArAging
      security:
        - sanctum: []
      responses:
        '200':
          description: AR aging buckets
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgingReport'

  /dashboards/cfo/ap-aging:
    get:
      tags: [CFO Dashboard]
      summary: Get accounts payable aging
      operationId: getApAging
      security:
        - sanctum: []
      responses:
        '200':
          description: AP aging buckets
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgingReport'

  /dashboards/cfo/roi-analysis:
    get:
      tags: [CFO Dashboard]
      summary: Get ROI analysis by project
      operationId: getRoiAnalysis
      security:
        - sanctum: []
      parameters:
        - name: project_id
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: ROI data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoiAnalysisList'

  # ========================================
  # GM DASHBOARD
  # ========================================

  /dashboards/gm:
    get:
      tags: [GM Dashboard]
      summary: Get GM operational dashboard
      description: |
        **Access:** GM and Ops Manager.
        Includes conflict alerts summary and team performance.
      operationId: getGmDashboard
      security:
        - sanctum: []
      responses:
        '200':
          description: GM dashboard data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GmDashboard'

  /dashboards/gm/conflict-summary:
    get:
      tags: [GM Dashboard]
      summary: Get conflict alerts summary
      operationId: getConflictSummary
      security:
        - sanctum: []
      responses:
        '200':
          description: Conflict summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConflictSummary'

  # ========================================
  # DIRECTOR DASHBOARD
  # ========================================

  /dashboards/director:
    get:
      tags: [Director Dashboard]
      summary: Get Director dashboard
      description: |
        **Access:** Directors only.
        Shows performance of SDDs under their management.
      operationId: getDirectorDashboard
      security:
        - sanctum: []
      responses:
        '200':
          description: Director dashboard data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DirectorDashboard'

  /dashboards/director/sdd-performance:
    get:
      tags: [Director Dashboard]
      summary: Get SDD performance metrics
      operationId: getSddPerformance
      security:
        - sanctum: []
      parameters:
        - name: sdd_id
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: SDD performance data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SddPerformanceList'

  # ========================================
  # EXPORTS
  # ========================================

  /exports/excel:
    post:
      tags: [Exports]
      summary: Export data to Excel
      operationId: exportExcel
      security:
        - sanctum: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [report_type]
              properties:
                report_type:
                  type: string
                  enum: [project_reports, department_reports, financials, conflicts]
                filters:
                  type: object
                  properties:
                    date_from:
                      type: string
                      format: date
                    date_to:
                      type: string
                      format: date
                    project_id:
                      type: integer
                    department_id:
                      type: integer
      responses:
        '202':
          description: Export started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportJob'

  /exports/{jobId}:
    get:
      tags: [Exports]
      summary: Get export status and download URL
      operationId: getExportStatus
      security:
        - sanctum: []
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Export status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportJob'

components:
  securitySchemes:
    sanctum:
      type: apiKey
      in: cookie
      name: laravel_session

  schemas:
    CeoDashboard:
      type: object
      properties:
        summary:
          type: object
          properties:
            active_projects:
              type: integer
            total_employees:
              type: integer
            open_conflicts:
              type: integer
            okr_progress:
              type: number
              description: Average OKR completion percentage
            high_attrition_count:
              type: integer
            high_churn_clients:
              type: integer
        recent_okrs:
          type: array
          items:
            $ref: '#/components/schemas/Okr'
        top_attrition_risks:
          type: array
          items:
            $ref: '#/components/schemas/AttritionRisk'
        top_churn_risks:
          type: array
          items:
            $ref: '#/components/schemas/ClientChurn'
        refreshed_at:
          type: string
          format: date-time

    CfoDashboard:
      type: object
      properties:
        summary:
          type: object
          properties:
            mtd_revenue:
              type: number
            mtd_expenses:
              type: number
            mtd_profit:
              type: number
            outstanding_ar:
              type: number
            outstanding_ap:
              type: number
            cash_runway_months:
              type: number
        profit_loss_trend:
          type: array
          items:
            type: object
            properties:
              month:
                type: string
              revenue:
                type: number
              expenses:
                type: number
              profit:
                type: number
        budget_alerts:
          type: array
          description: Projects over budget
          items:
            type: object
            properties:
              project_name:
                type: string
              variance_percent:
                type: number
        refreshed_at:
          type: string
          format: date-time

    GmDashboard:
      type: object
      properties:
        summary:
          type: object
          properties:
            open_conflicts:
              type: integer
            pending_reports:
              type: integer
            active_projects:
              type: integer
            total_sdds:
              type: integer
            total_dept_managers:
              type: integer
        recent_conflicts:
          type: array
          items:
            $ref: '#/components/schemas/ConflictSummaryItem'
        missing_reports:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                enum: [project, department]
              name:
                type: string
              submitter_name:
                type: string
              period:
                type: string

    DirectorDashboard:
      type: object
      properties:
        summary:
          type: object
          properties:
            managed_sdds:
              type: integer
            total_projects:
              type: integer
            on_track_projects:
              type: integer
            at_risk_projects:
              type: integer
        sdd_summaries:
          type: array
          items:
            type: object
            properties:
              sdd_id:
                type: integer
              sdd_name:
                type: string
              projects_count:
                type: integer
              reports_submitted:
                type: integer
              reports_pending:
                type: integer

    Okr:
      type: object
      properties:
        id:
          type: integer
        objective:
          type: string
        owner_name:
          type: string
        progress:
          type: number
          description: Percentage 0-100
        status:
          type: string
          enum: [on_track, at_risk, achieved, missed]
        key_results:
          type: array
          items:
            $ref: '#/components/schemas/KeyResult'

    KeyResult:
      type: object
      properties:
        id:
          type: integer
        description:
          type: string
        target_value:
          type: number
        current_value:
          type: number
        unit:
          type: string
        progress:
          type: number

    OkrList:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Okr'
        summary:
          type: object
          properties:
            total:
              type: integer
            on_track:
              type: integer
            at_risk:
              type: integer
            achieved:
              type: integer

    AttritionRisk:
      type: object
      properties:
        employee_id:
          type: integer
        employee_name:
          type: string
        department:
          type: string
        risk_score:
          type: number
          description: 0-1 probability
        risk_factors:
          type: array
          items:
            type: string
        tenure_months:
          type: integer

    AttritionRiskList:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/AttritionRisk'
        meta:
          type: object
          properties:
            threshold_used:
              type: number
            total_employees:
              type: integer
            high_risk_count:
              type: integer

    ClientChurn:
      type: object
      properties:
        client_id:
          type: integer
        client_name:
          type: string
        churn_probability:
          type: number
        monthly_revenue:
          type: number
        contract_end:
          type: string
          format: date
        risk_factors:
          type: array
          items:
            type: string

    ClientChurnList:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/ClientChurn'

    ProfitLossStatement:
      type: object
      properties:
        period:
          type: string
        start_date:
          type: string
          format: date
        end_date:
          type: string
          format: date
        revenue:
          type: object
          properties:
            total:
              type: number
            by_category:
              type: array
              items:
                type: object
                properties:
                  category:
                    type: string
                  amount:
                    type: number
        expenses:
          type: object
          properties:
            total:
              type: number
            by_category:
              type: array
              items:
                type: object
                properties:
                  category:
                    type: string
                  amount:
                    type: number
        net_profit:
          type: number
        margin_percent:
          type: number

    CashRunway:
      type: object
      properties:
        current_cash:
          type: number
        monthly_burn_rate:
          type: number
        runway_months:
          type: number
        projected_zero_date:
          type: string
          format: date
          nullable: true
        trend:
          type: array
          items:
            type: object
            properties:
              month:
                type: string
              projected_balance:
                type: number

    BudgetVariance:
      type: object
      properties:
        project_id:
          type: integer
        project_name:
          type: string
        budgeted:
          type: number
        actual:
          type: number
        variance:
          type: number
        variance_percent:
          type: number
        status:
          type: string
          enum: [under_budget, on_budget, over_budget]

    BudgetVarianceList:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/BudgetVariance'
        totals:
          type: object
          properties:
            total_budgeted:
              type: number
            total_actual:
              type: number
            total_variance:
              type: number

    AgingReport:
      type: object
      properties:
        type:
          type: string
          enum: [receivable, payable]
        buckets:
          type: array
          items:
            type: object
            properties:
              range:
                type: string
                description: e.g., "0-30 days", "31-60 days"
              amount:
                type: number
              count:
                type: integer
              invoices:
                type: array
                items:
                  type: object
                  properties:
                    invoice_id:
                      type: integer
                    client_vendor:
                      type: string
                    amount:
                      type: number
                    due_date:
                      type: string
                      format: date
                    days_outstanding:
                      type: integer
        total:
          type: number

    RoiAnalysis:
      type: object
      properties:
        project_id:
          type: integer
        project_name:
          type: string
        total_investment:
          type: number
        total_revenue:
          type: number
        roi_percent:
          type: number
        payback_months:
          type: number
          nullable: true

    RoiAnalysisList:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/RoiAnalysis'

    ConflictSummary:
      type: object
      properties:
        open:
          type: integer
        escalated:
          type: integer
        resolved_this_week:
          type: integer
        avg_resolution_days:
          type: number

    ConflictSummaryItem:
      type: object
      properties:
        id:
          type: integer
        employee_name:
          type: string
        discrepancy_hours:
          type: number
        status:
          type: string
        days_open:
          type: integer

    SddPerformance:
      type: object
      properties:
        sdd_id:
          type: integer
        sdd_name:
          type: string
        projects:
          type: array
          items:
            type: object
            properties:
              project_id:
                type: integer
              project_name:
                type: string
              status:
                type: string
              budget_status:
                type: string
              reports_submitted:
                type: integer
              on_time_submissions:
                type: integer

    SddPerformanceList:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/SddPerformance'

    ExportJob:
      type: object
      properties:
        job_id:
          type: string
        status:
          type: string
          enum: [pending, processing, completed, failed]
        download_url:
          type: string
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true
        error_message:
          type: string
          nullable: true
