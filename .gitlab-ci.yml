# GitLab CI/CD Pipeline Configuration
# Team Management Platform - Dual Independent Reporting System

# Define pipeline stages
stages:
  - test
  - lint
  - security
  - build
  - deploy

# Global variables
variables:
  # Docker settings
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  
  # Backend settings
  DB_CONNECTION: pgsql
  DB_HOST: postgres
  DB_PORT: 5432
  DB_DATABASE: team_mgmt_test
  DB_USERNAME: app
  DB_PASSWORD: secret
  
  REDIS_HOST: redis
  REDIS_PORT: 6379
  
  # Cache settings
  COMPOSER_CACHE_DIR: "$CI_PROJECT_DIR/.composer-cache"
  NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.npm-cache"

# Cache configuration for dependencies
cache:
  paths:
    - .composer-cache/
    - .npm-cache/
    - backend/vendor/
    - frontend/node_modules/

# ===========================================
# TEST STAGE
# ===========================================

# Backend Tests (Laravel PHPUnit)
backend-tests:
  stage: test
  image: php:8.2-fpm
  services:
    - postgres:15-alpine
    - redis:7-alpine
  variables:
    POSTGRES_DB: team_mgmt_test
    POSTGRES_USER: app
    POSTGRES_PASSWORD: secret
    POSTGRES_HOST_AUTH_METHOD: trust
  before_script:
    # Install system dependencies
    - apt-get update && apt-get install -y git unzip libpq-dev libzip-dev
    
    # Install PHP extensions
    - docker-php-ext-install pdo pdo_pgsql pgsql zip
    
    # Install Composer
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    
    # Install backend dependencies
    - cd backend
    - composer install --prefer-dist --no-progress --no-interaction
    
    # Prepare environment
    - cp .env.example .env
    - php artisan key:generate
    - php artisan config:clear
    
    # Run migrations
    - php artisan migrate --force
  script:
    # Run PHPUnit tests with coverage
    - php artisan test --coverage --min=70
  coverage: '/^\s*Lines:\s*\d+.\d+\%/'
  artifacts:
    when: always
    reports:
      junit: backend/test-results.xml
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage.xml
    paths:
      - backend/coverage/
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

# Frontend Tests (Vitest)
frontend-tests:
  stage: test
  image: node:20-alpine
  before_script:
    - cd frontend
    - npm ci --cache .npm-cache --prefer-offline
  script:
    # Run Vitest with coverage
    - npm run test:ci
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      junit: frontend/test-results.xml
      coverage_report:
        coverage_format: cobertura
        path: frontend/coverage/cobertura-coverage.xml
    paths:
      - frontend/coverage/
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

# ===========================================
# LINT STAGE
# ===========================================

# PHP Code Style Check
php-cs-fixer:
  stage: lint
  image: php:8.2-cli
  before_script:
    - cd backend
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer global require friendsofphp/php-cs-fixer
  script:
    - /root/.composer/vendor/bin/php-cs-fixer fix --dry-run --diff --verbose
  allow_failure: true
  only:
    - merge_requests
    - main

# ESLint & TypeScript Check
eslint:
  stage: lint
  image: node:20-alpine
  before_script:
    - cd frontend
    - npm ci --cache .npm-cache --prefer-offline
  script:
    - npm run lint
  allow_failure: true
  only:
    - merge_requests
    - main

# ===========================================
# SECURITY STAGE
# ===========================================

# Backend Security Audit (Composer)
composer-audit:
  stage: security
  image: php:8.2-cli
  before_script:
    - cd backend
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer install --no-dev --prefer-dist --no-progress
  script:
    - composer audit
  allow_failure: true
  only:
    - merge_requests
    - main
    - schedules

# Frontend Security Audit (npm)
npm-audit:
  stage: security
  image: node:20-alpine
  before_script:
    - cd frontend
  script:
    - npm audit --production --audit-level=high
  allow_failure: true
  only:
    - merge_requests
    - main
    - schedules

# Secret Detection
secret-detection:
  stage: security
  image: alpine:latest
  before_script:
    - apk add --no-cache git
  script:
    - |
      echo "Checking for exposed secrets..."
      # Check for common secret patterns
      git grep -E '(password|secret|api_key|token)\s*=\s*["\047][^"\047]{8,}["\047]' || true
      # Fail if any APP_KEY found in git history (should be in .env only)
      if git log --all -p | grep -i "APP_KEY=base64:" | grep -v ".env.example"; then
        echo "ERROR: APP_KEY found in git history!"
        exit 1
      fi
  allow_failure: true
  only:
    - merge_requests
    - main

# ===========================================
# BUILD STAGE
# ===========================================

# Build Backend Docker Image
build-backend:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - cd backend
    - docker build -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA .
    - docker tag $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA $CI_REGISTRY_IMAGE/backend:latest
    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/backend:latest
  only:
    - main
    - develop

# Build Frontend Docker Image
build-frontend:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - cd frontend
    - docker build -t $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA .
    - docker tag $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA $CI_REGISTRY_IMAGE/frontend:latest
    - docker push $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/frontend:latest
  only:
    - main
    - develop

# ===========================================
# DEPLOY STAGE
# ===========================================

# Deploy to Staging
deploy-staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $STAGING_SERVER >> ~/.ssh/known_hosts
  script:
    - |
      ssh $STAGING_USER@$STAGING_SERVER << 'EOF'
        cd /var/www/team-management-platform
        git pull origin develop
        docker-compose pull
        docker-compose up -d --build
        docker-compose exec -T backend php artisan migrate --force
        docker-compose exec -T backend php artisan config:cache
        docker-compose exec -T backend php artisan route:cache
      EOF
  environment:
    name: staging
    url: https://staging.yourcompany.com
  only:
    - develop
  when: manual

# Deploy to Production
deploy-production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $PRODUCTION_SERVER >> ~/.ssh/known_hosts
  script:
    - |
      ssh $PRODUCTION_USER@$PRODUCTION_SERVER << 'EOF'
        cd /var/www/team-management-platform
        
        # Backup database before deployment
        docker-compose exec -T postgres pg_dump -U app team_mgmt > backup-$(date +%Y%m%d-%H%M%S).sql
        
        # Deploy
        git pull origin main
        docker-compose pull
        docker-compose up -d --build
        docker-compose exec -T backend php artisan migrate --force
        docker-compose exec -T backend php artisan config:cache
        docker-compose exec -T backend php artisan route:cache
        docker-compose exec -T backend php artisan optimize
        
        # Health check
        curl --fail http://localhost/api/health || exit 1
      EOF
  environment:
    name: production
    url: https://yourcompany.com
  only:
    - main
  when: manual
  needs:
    - backend-tests
    - frontend-tests

# ===========================================
# SCHEDULED JOBS
# ===========================================

# Daily Security Scan (run on schedule)
security-scan-daily:
  stage: security
  image: aquasec/trivy:latest
  script:
    - trivy fs --severity HIGH,CRITICAL .
  only:
    - schedules
  allow_failure: false
